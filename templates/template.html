<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SigmaFold</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    
    body {
        zoom: 0.7;
    }

    #alert-container {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 32rem;
      z-index: 9999;
      pointer-events: none;
      perspective: 1200px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #alert-container .alert {
      pointer-events: auto;
      position: absolute;
      left: 0;
      right: 0;
      margin: auto;
      width: 100%;
      box-sizing: border-box;
      border-radius: 0.5rem;
      box-shadow: 0 6px 24px 0 rgba(0,0,0,0.23), 0 1.5px 3px 0 rgba(0,0,0,0.15);
      opacity: 0;
      transition:
        opacity 0.4s cubic-bezier(.4,0,.2,1),
        transform 0.4s cubic-bezier(.4,0,.2,1);
      will-change: opacity, transform;
    }

    html, body {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-mono">
  <!-- Centered main content, no left margin for nav bar -->
  <div class="flex justify-center items-center min-h-screen">
    <div class="w-full max-w-4xl space-y-8">
      <h1 class="text-4xl font-bold text-center mt-10">SigmaFold</h1>
      <div>
        <a id="viewport_link"
             class="p-4 bg-gray-800 border border-gray-700 rounded text-sm whitespace-pre-wrap overflow-x-auto" href="viewport">Viewport</a>
        <a id="viewport_link"
             class="p-4 bg-gray-800 border border-gray-700 rounded text-sm whitespace-pre-wrap overflow-x-auto" href="status">Alphafold</a>
      </div>

      <div id="alert-container"></div>

      <div>
        <label for="protein_name" class="block text-lg font-semibold mb-2">Protein Name (UniProt ID):</label>
        <input type="text" id="protein_name" name="protein_name"
               class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-600 text-white focus:outline-none focus:ring focus:border-blue-400" />
        
      </div>
      
      <div>
        <h2 class="text-xl font-semibold mb-2">FASTA Output</h2>
        <div id="result"
             class="p-4 bg-gray-800 border border-gray-700 rounded text-sm whitespace-pre-wrap overflow-x-auto"></div>
        
      </div>
        <div class="flex flex-wrap gap-4">
            <button onclick="return_fasta()"
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Return FASTA</button>
            <button onclick="save_fasta()"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">Save FASTA</button>
      </div>

      <div>
        <label for="files" class="block text-lg font-semibold mb-2">Choose a file:</label>
        <select id="files"
                class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-600 text-white focus:outline-none focus:ring">
        </select>
      </div>

      
      <div class="flex flex-wrap gap-4">
        
        <button onclick="view_fasta()"
                class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">View FASTA</button>
        <button onclick="delete_fasta()"
                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Delete FASTA</button>
        <button onclick="run_alphafold()"
                class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition">Run Alphafold</button>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-2">FASTA Viewer</h2>
        <div id="result3"
             class="p-4 bg-gray-800 border border-gray-700 rounded text-sm whitespace-pre-wrap overflow-x-auto"></div>
      </div>
      
    </div>
  </div>
  <script>
    let default_url = window.location;

    // Keep a queue of all active alerts
    let alertQueue = [];

    let alertCnt = 0;

    function updateAlert3DStack() {
      const alerts = Array.from(document.querySelectorAll("#alert-container .alert"));
      const total = alerts.length;
      const visibleStack = 5;
      // oldest at i=0, newest at i=n-1
      alerts.forEach((alert, i) => {
        const yOffset = -18;
        const z = -i * 24;
        const scale = 1 - i * 0.04;
        const rotate = i * 2.5;
        const translateY = Math.max(i, 0) * yOffset;
        alert.style.transform =
          `translateY(${translateY}px) scale(${scale}) rotateX(${rotate}deg) translateZ(${z}px)`;
        alert.style.zIndex = 100 + total - i;
        alert.style.filter = i > 2 ? 'blur(0.8px)' : '';
        alert.style.opacity = i < visibleStack ? '1' : '0.5';
        alert.style.pointerEvents = i === total - 1 ? 'auto' : 'none'; // Only newest/front is clickable
      });
    }

    // Remove the oldest alert in the queue, fade it out, then remove from DOM and queue
    function removeOldestAlert() {
      if (alertQueue.length === 0) return;
      const oldest = alertQueue[0]; // FIFO
      if (!oldest) return;
      // Prevent multiple removals
      if (oldest._removing) return;
      oldest._removing = true;
      oldest.style.opacity = '0';
      setTimeout(() => {
        if (oldest.parentElement) {
          oldest.remove();
          alertQueue = alertQueue.filter(a => a !== oldest);
          updateAlert3DStack();
        }
      }, 100);
    }

    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alert-container');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert p-4 flex items-center justify-between font-mono shadow-lg`;

      let bgColor, textColor;
      switch (type) {
        case 'success':
          bgColor = 'bg-green-700';
          textColor = 'text-green-100';
          break;
        case 'error':
          bgColor = 'bg-red-700';
          textColor = 'text-red-100';
          break;
        case 'info':
        default:
          bgColor = 'bg-blue-700';
          textColor = 'text-blue-100';
          break;
      }
      alertDiv.classList.add(bgColor, textColor);
      alertDiv.innerHTML = `
        <span class="font-semibold">${message}</span>
        <button class="ml-4 w-10 h-10 flex items-center justify-center text-2xl opacity-75 hover:opacity-100 focus:outline-none"
          onclick="closeAlert(this.parentElement); return false;"
          style="pointer-events:auto;">&times;</button>
      `;

      alertContainer.appendChild(alertDiv);
      alertQueue.push(alertDiv);

      requestAnimationFrame(() => {
        alertDiv.style.opacity = '1';
      });
      updateAlert3DStack();

      // Remove after timeout, but for oldest banner, not this one
      // Only trigger a removal if this is the first alert or if there's more than one
      if (alertQueue.length === 1) {
        setTimeout(function processQueue() {
          removeOldestAlert();
          if (alertQueue.length > 0) {
            setTimeout(processQueue, 500); // show each alert for 700ms before removing the next
          }
        }, 1000); // initial delay for first alert
      }

      // Also allow removal via button
      alertDiv.__removeAlert = function() {
        // Remove from queue and DOM immediately, then update stack
        if (alertDiv.parentElement) {
          alertDiv.style.opacity = '0';
          setTimeout(() => {
            if (alertDiv.parentElement) {
              alertDiv.remove();
              alertQueue = alertQueue.filter(a => a !== alertDiv);
              updateAlert3DStack();
            }
          }, 400);
        }
      };
    }

    // Helper for close button
    function closeAlert(alertDiv) {
      if (alertDiv && typeof alertDiv.__removeAlert === "function") {
        alertDiv.__removeAlert();
      }
    }

    async function return_fasta() {
      const inputValue = document.getElementById("protein_name").value;
      const resultDiv = document.getElementById("result");
      if (!inputValue) {
        showAlert('Please enter a UniProt ID for the protein.', 'info');
        return;
      }

      const baseUrl = `https://rest.uniprot.org/uniprotkb/${encodeURIComponent(inputValue)}`;
      try {
        const response = await fetch(baseUrl, {
          method: "GET",
          headers: { "Accept": "application/json" }
        });

        if (!response.ok) {
          if (response.status === 404) {
            showAlert(`Protein with ID "${inputValue}" not found. Please check the UniProt ID.`, 'error');
          } else {
            showAlert(`Error fetching FASTA: ${response.statusText}`, 'error');
          }
          resultDiv.textContent = '';
          return;
        }

        const data = await response.json();

        const source_database = data.entryType === "Reviewed" ? "sp" : "tr";
        const accession_number = data.primaryAccession;
        const entry_name = data.uniProtkbId;
        const fullname = data.proteinDescription?.recommendedName?.fullName?.value || "Unknown Protein";
        const og_species = data.organism?.scientificName || "Unknown Species";
        const taxon_id = data.organism?.taxonId || "0000";
        const geneName = data.genes?.[0]?.geneName?.value || "UNKNOWN";
        const pExistence = data.proteinExistence?.type?.match(/\d+/)?.[0] || "1";
        const SV = data.entryAudit?.sequenceVersion || "1";

        const fastaHeader = `>${source_database}|${accession_number}|${entry_name} ${fullname} OS=${og_species} OX=${taxon_id} GN=${geneName} PE=${pExistence} SV=${SV}`;
        const AAS = data.sequence.value;
        let formattedAAS = '';
        for (let i = 0; i < AAS.length; i += 60) {
          formattedAAS += AAS.slice(i, i + 60) + '\n';
        }

        resultDiv.textContent = fastaHeader + "\n" + formattedAAS.trim();
        showAlert('FASTA returned successfully!', 'success');

      } catch (error) {
        console.error('Error in return_fasta:', error);
        showAlert(`An unexpected error occurred: ${error.message}`, 'error');
        resultDiv.textContent = '';
      }
    }

    async function save_fasta() {
      const inputValue = document.getElementById("protein_name").value;
      const textContent = document.getElementById("result").textContent;

      if (!textContent) {
        showAlert('No FASTA data to save. Please "Return FASTA" first.', 'info');
        return;
      }
      if (!inputValue) {
        showAlert('Please enter a UniProt ID to name the file.', 'info');
        return;
      }
      try {
        const save_response = await fetch(`${default_url}/save_fasta?file_number=${encodeURIComponent(inputValue)}&bruh=${encodeURIComponent(textContent)}`);
        if (!save_response.ok) throw new Error(`HTTP error! status: ${save_response.status}`);
        const data = await save_response.json();

        populateFileSelect();
        showAlert(data.message, 'success');

      } catch (error) {
        console.error('Error in save_fasta:', error);
        showAlert(`Error saving FASTA: ${error.message}`, 'error');
      }
    }

    async function view_fasta() {
      const fastaSelect = document.getElementById("files");
      const selectedFile = fastaSelect.value;
      const resultDiv = document.getElementById("result3");

      if (!selectedFile) {
        showAlert('Please select a FASTA file to view.', 'info');
        resultDiv.textContent = '';
        return;
      }

      try {
        const response = await fetch(`${default_url}/return_fasta2?file=${encodeURIComponent(selectedFile)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        resultDiv.textContent = data.message;
        showAlert(`Viewing file: ${selectedFile}`, 'info');
      } catch (error) {
        console.error('Error in view_fasta:', error);
        showAlert(`Error viewing FASTA file: ${error.message}`, 'error');
        resultDiv.textContent = '';
      }
    }

    async function delete_fasta() {
      const fastaSelect = document.getElementById("files");
      const selectedFile = fastaSelect.value;
      if (!selectedFile) {
        showAlert('Please select a FASTA file to delete.', 'info');
        return;
      }
      try {
        const response = await fetch(`${default_url}/delete_fasta?file=${encodeURIComponent(selectedFile)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        showAlert(`Deleted file: ${selectedFile}`, 'info');
        populateFileSelect();
      } catch (error) {
        console.error('Error in delete_fasta:', error);
        showAlert(`Error deleting FASTA file: ${error.message}`, 'error');
      }
    }

    async function populateFileSelect() {
      const select = document.getElementById("files");
      try {
        const response = await fetch(`${default_url}/list_files`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        select.innerHTML = "";
        if (data.files && Array.isArray(data.files) && data.files.length > 0) {
          data.files.forEach(filename => {
            const option = document.createElement("option");
            option.value = filename;
            option.textContent = filename;
            select.appendChild(option);
          });
          if (alertCnt == 0) {
            alertCnt++;
            return;
          }
          showAlert('Files loaded successfully!', 'success');
        } else {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No files found";
          select.appendChild(option);
          
          if (alertCnt == 0) {
            alertCnt++;
            return;
          }
          showAlert('No saved FASTA files found.', 'info');
        }
      } catch (error) {
        console.error('Error populating file select:', error);
        select.innerHTML = "<option value=''>Error loading files</option>";
        
        if (alertCnt == 0) {
          alertCnt++;
          return;
        }
        showAlert(`Error loading files: ${error.message}`, 'error');
      }
    }


    async function run_alphafold() {
      const fastaSelect = document.getElementById("files");
      const selectedFile = fastaSelect.value;
      if (!selectedFile) {
        showAlert('Please select a FASTA file to view.', 'info');
        resultDiv.textContent = '';
        return;
      }

      try {
        const response = await fetch(`${default_url}run_alphafold?file=${encodeURIComponent(selectedFile)}`)
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log(data);
        showAlert("Successfully began alphafold process")
      } catch (error) {
        showAlert(`Error running Alphafold: ${error.message}`, 'error')
      }
    }

    window.onload = populateFileSelect;
  </script>
</body>
</html>